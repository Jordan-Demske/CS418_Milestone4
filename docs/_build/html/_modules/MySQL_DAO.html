
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MySQL_DAO &#8212; CS418_Milestone_4  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for MySQL_DAO</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="kn">import</span> <span class="n">errorcode</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>

<span class="kn">import</span> <span class="nn">configparser</span>


<div class="viewcode-block" id="MySQLConnectionManager"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQLConnectionManager">[docs]</a><span class="k">class</span> <span class="nc">MySQLConnectionManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class MySQLConnectionManager</span>
<span class="sd">    Creates the connection based on a config file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="s1">&#39;connection_data.conf&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cnx</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQL&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQL&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQL&#39;</span><span class="p">][</span><span class="s1">&#39;database&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnx</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="MySQLCursorManager"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQLCursorManager">[docs]</a><span class="k">class</span> <span class="nc">MySQLCursorManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class MySQLCursorManager</span>
<span class="sd">    Handles the connection&#39;s cursor</span>

<span class="sd">    :param cnx: The Connection</span>
<span class="sd">    :type cnx: MySQLConnectionManager</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">buffered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="MySQL_DAO"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO">[docs]</a><span class="k">class</span> <span class="nc">MySQL_DAO</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class DAO</span>
<span class="sd">    The DAO part of the TMB</span>

<span class="sd">    :param is_stub: Optional, whether the DAO is a test stub or not</span>
<span class="sd">    :type is_stub: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ais_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="s1">&#39;MMSI&#39;</span><span class="p">]</span>
    <span class="n">static_data_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CallSign&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;VesselType&#39;</span><span class="p">,</span> <span class="s1">&#39;CargoType&#39;</span><span class="p">,</span> <span class="s1">&#39;Length&#39;</span><span class="p">,</span> <span class="s1">&#39;Breadth&#39;</span><span class="p">,</span> <span class="s1">&#39;Draught&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Destination&#39;</span><span class="p">,</span> <span class="s1">&#39;DestinationId&#39;</span><span class="p">]</span>
    <span class="n">position_report_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RoT&#39;</span><span class="p">,</span> <span class="s1">&#39;SoG&#39;</span><span class="p">,</span> <span class="s1">&#39;CoG&#39;</span><span class="p">,</span> <span class="s1">&#39;Heading&#39;</span><span class="p">]</span>
    <span class="n">position_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stub</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span> <span class="o">=</span> <span class="n">stub</span>

<div class="viewcode-block" id="MySQL_DAO.format_ais_message"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.format_ais_message">[docs]</a>    <span class="k">def</span> <span class="nf">format_ais_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats an AIS Message to show the Class, MMSI, IMO, and Timestamp.</span>

<span class="sd">        :param msg: a dict consisting of a list of attributes for the message</span>
<span class="sd">        :type msg: dict</span>
<span class="sd">        :return: object {&#39;Class&#39;: ... , &#39;MMSI&#39;: ... , } describing the AIS Message</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Timestamp&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">isoparse</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">])</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;IMO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;IMO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;IMO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ais_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="MySQL_DAO.format_position_report"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.format_position_report">[docs]</a>    <span class="k">def</span> <span class="nf">format_position_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats a Position Report to show the RoT, SoG, CoG, Heading, Status, and Position.</span>

<span class="sd">        :param msg: a dict consisting of a list of attributes for the report</span>
<span class="sd">        :type msg: dict</span>
<span class="sd">        :return: object {&#39;RoT&#39;: ... , &#39;SoG&#39;: ... , } describing the Position Report</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Position&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_parameters</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">{}:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;Status&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Unknown value&quot;</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_report_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="MySQL_DAO.format_static_data"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.format_static_data">[docs]</a>    <span class="k">def</span> <span class="nf">format_static_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats a Static Data message to show the CallSign, Name, VesselType, CargoType, Length, Breadth, Draught,</span>
<span class="sd">        Destination, DestinationId, and ETA.</span>

<span class="sd">        :param msg: a dict consisting of a list of attributes for the static data message</span>
<span class="sd">        :type msg: dict</span>
<span class="sd">        :return: object {&#39;CallSign&#39;: ... , &#39;Name&#39;: ... , } describing the Static Data</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;ETA&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">isoparse</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;ETA&#39;</span><span class="p">])</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;ETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;ETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_data_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="MySQL_DAO.insert_ais_batch"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.insert_ais_batch">[docs]</a>    <span class="k">def</span> <span class="nf">insert_ais_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 1, Priority 1</span>
<span class="sd">        From a set of JSON data, inserts every AIS Message into the database and returns the number of insertions.</span>

<span class="sd">        :param msg: a json string</span>
<span class="sd">        :type msg: str</span>
<span class="sd">        :raises [BaseException]: If the JSON cannot be loaded correctly</span>
<span class="sd">        :return: JSON string containing {&#39;inserts&#39;: ...} with the count of insertions</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;inserts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)})</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_ais_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;inserts&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span></div>

<div class="viewcode-block" id="MySQL_DAO.insert_ais_message"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.insert_ais_message">[docs]</a>    <span class="k">def</span> <span class="nf">insert_ais_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 2, Priority 2</span>
<span class="sd">        From a dictionary filled with message values, insert the values into the database and return a success message.</span>

<span class="sd">        :param msg: A dictionary of values to insert</span>
<span class="sd">        :type msg: dict</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON string containing {&#39;success&#39;: ...} with either 1 or 0 depending on the success of the insert</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_ais_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;MsgType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;position_report&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="s1">&#39;pos&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="s1">&#39;stat&#39;</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO AIS_MESSAGE(Timestamp, MMSI, Class) VALUES(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;&quot;&quot;</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;MMSI&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]))</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

                    <span class="k">if</span> <span class="s2">&quot;MsgType&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;MsgType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;position_report&#39;</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_position_report</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">map_views</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">map_views</span><span class="p">)):</span>
                                <span class="n">map_view_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                              <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                    <span class="sd">&quot;&quot;&quot;SELECT * from MAP_VIEW WHERE LongitudeW = %s AND LongitudeE = %s AND LatitudeN = %s AND LatitudeS = %s;&quot;&quot;&quot;</span><span class="p">,</span>
                                    <span class="p">(</span><span class="n">map_view_dict</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">],</span> <span class="n">map_view_dict</span><span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">],</span> <span class="n">map_view_dict</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">],</span>
                                     <span class="n">map_view_dict</span><span class="p">[</span><span class="s1">&#39;south&#39;</span><span class="p">]))</span>
                                <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

                                <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">map_views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="n">stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO POSITION_REPORT(AISMessage_Id, NavigationalStatus, Longitude, Latitude, RoT, SoG, CoG, Heading, LastStaticData_Id, MapView1_Id, MapView2_Id, MapView3_Id)</span>
<span class="s2">                                  VALUES(LAST_INSERT_ID(), </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, (SELECT MAX(STATIC_DATA.AISMessage_ID) FROM STATIC_DATA, AIS_MESSAGE WHERE STATIC_DATA.AISMessage_Id = AIS_MESSAGE.Id AND AIS_MESSAGE.MMSI = </span><span class="si">%s</span><span class="s2">), </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;&quot;&quot;</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;RoT&#39;</span><span class="p">],</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;SoG&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;CoG&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Heading&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;MMSI&#39;</span><span class="p">],</span> <span class="n">map_views</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map_views</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">map_views</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;MsgType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;static_data&#39;</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_static_data</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;IMO&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT IMO FROM VESSEL WHERE IMO = </span><span class="si">%s</span><span class="s2">;&quot;&quot;&quot;</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;IMO&#39;</span><span class="p">],))</span>
                            <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE AIS_MESSAGE SET Vessel_IMO = </span><span class="si">%s</span><span class="s2"> where Id = LAST_INSERT_ID();&quot;&quot;&quot;</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;IMO&#39;</span><span class="p">],))</span>
                                <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                        <span class="n">stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO STATIC_DATA(AISMessage_ID, AISIMO, CallSign, Name, VesselType, CargoType, Length, Breadth, Draught, AISDestination, ETA, DestinationPort_Id)</span>
<span class="s2">                                  VALUES(LAST_INSERT_ID(), </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;&quot;&quot;</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;IMO&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;CallSign&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;VesselType&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;CargoType&#39;</span><span class="p">],</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Length&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Breadth&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Draught&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Destination&#39;</span><span class="p">],</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;ETA&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;DestinationId&#39;</span><span class="p">]))</span>
                        <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span></div>

<div class="viewcode-block" id="MySQL_DAO.delete_ais_messages"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.delete_ais_messages">[docs]</a>    <span class="k">def</span> <span class="nf">delete_ais_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes all AIS Messages. Used for testing.</span>

<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON string containing {&#39;success&#39;: ...} with either 1 or 0 depending on the success of the insert</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;DELETE FROM POSITION_REPORT;&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;DELETE FROM STATIC_DATA;&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;DELETE FROM AIS_MESSAGE;&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;ALTER TABLE AIS_MESSAGE AUTO_INCREMENT = 1;&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.delete_old_ais_messages"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.delete_old_ais_messages">[docs]</a>    <span class="k">def</span> <span class="nf">delete_old_ais_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 3, Priority 1</span>
<span class="sd">        Deletes all AIS Messages older than five minutes.</span>

<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON string containing {&#39;deletions&#39;: ...} with the number of deletions</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;deletions&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;DELETE POSITION_REPORT FROM POSITION_REPORT JOIN AIS_MESSAGE ON AISMessage_ID = AIS_MESSAGE.Id WHERE AIS_MESSAGE.Timestamp &lt; (CURRENT_TIMESTAMP - INTERVAL 5 MINUTE);&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;DELETE STATIC_DATA FROM STATIC_DATA JOIN AIS_MESSAGE ON AISMessage_ID = AIS_MESSAGE.Id WHERE AIS_MESSAGE.Timestamp &lt; (CURRENT_TIMESTAMP - INTERVAL 5 MINUTE);&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;DELETE FROM AIS_MESSAGE WHERE Timestamp &lt; (CURRENT_TIMESTAMP - INTERVAL 5 MINUTE);&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">deletions</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;deletions&quot;</span><span class="p">:</span> <span class="n">deletions</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.get_vessel_imo"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.get_vessel_imo">[docs]</a>    <span class="k">def</span> <span class="nf">get_vessel_imo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the permanent data&#39;s IMO for a ship with a given MMSI</span>

<span class="sd">        :param mmsi: The vessel MMSI</span>
<span class="sd">        :type mmsi: int</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: The IMO</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1234567</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT IMO FROM VESSEL WHERE MMSI = </span><span class="si">%s</span><span class="s2">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;NULL&quot;</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.get_vessel_name"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.get_vessel_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_vessel_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the Name of a vessel found in the permanent data based on a given MMSI</span>

<span class="sd">        :param mmsi: The Vessel MMSI</span>
<span class="sd">        :type mmsi: int</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: The vessel name</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Fake Name&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT Name FROM VESSEL WHERE MMSI = </span><span class="si">%s</span><span class="s2">;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;NULL&quot;</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.get_optional_vessel_data"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.get_optional_vessel_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_optional_vessel_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From a vessel&#39;s MMSI, return the IMO and name first from testing the transient data and then relying on the</span>
<span class="sd">        permanent data if no such transient data exists.</span>

<span class="sd">        :param mmsi: A dictionary of values to insert</span>
<span class="sd">        :type mmsi: dict</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: List consisting of the IMO followed by the name</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NULL&quot;</span><span class="p">,</span> <span class="s2">&quot;NULL&quot;</span><span class="p">]</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;SELECT Name, AISIMO FROM STATIC_DATA, AIS_MESSAGE WHERE AISMessage_Id = Id AND MMSI = %s ORDER BY Timestamp ASC;&quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vessel_name</span><span class="p">(</span><span class="n">mmsi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vessel_imo</span><span class="p">(</span><span class="n">mmsi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.create_vessel_document"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.create_vessel_document">[docs]</a>    <span class="k">def</span> <span class="nf">create_vessel_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vessel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From a list of vessel values, return a dictionary with the MMSI, Latitude, Longitude, Name, and IMO</span>

<span class="sd">        :param vessel: A list of vessel values</span>
<span class="sd">        :type vessel: list</span>
<span class="sd">        :return: Dictionary containing {&#39;MMSI&#39;: ..., &#39;lat&#39;: ...,} with the values of the vessel</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="n">optional_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_vessel_data</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">optional_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="n">optional_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="MySQL_DAO.select_all_recent_positions"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.select_all_recent_positions">[docs]</a>    <span class="k">def</span> <span class="nf">select_all_recent_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 4, Priority 1</span>
<span class="sd">        Select all recent ship positions for each vessel MMSI</span>

<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: A JSON list of ship documents formed from create_vessel_document(), {&#39;vessels&#39;: [...]}</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude</span>
<span class="s2">                                      FROM (SELECT Id, MMSI, MAX(Timestamp) as LatestTime from AIS_MESSAGE GROUP BY MMSI) t, POSITION_REPORT as pos</span>
<span class="s2">                                      WHERE t.Id = pos.AISMessage_Id ORDER BY t.LatestTime DESC;&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_vessel_document</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="n">vessels</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.select_most_recent_from_mmsi"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.select_most_recent_from_mmsi">[docs]</a>    <span class="k">def</span> <span class="nf">select_most_recent_from_mmsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 5, Priority 1</span>
<span class="sd">        From an MMSI, select that vessel&#39;s most recent position.</span>

<span class="sd">        :param mmsi: The vessel MMSI</span>
<span class="sd">        :type mmsi: int</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: A JSON position document of the form {&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude, t.Vessel_IMO</span>
<span class="s2">                                      FROM (SELECT Id, MMSI, Vessel_IMO, Timestamp from AIS_MESSAGE WHERE MMSI = </span><span class="si">%s</span><span class="s2"> ORDER BY Timestamp DESC) t, POSITION_REPORT as pos</span>
<span class="s2">                                      WHERE t.Id = pos.AISMessage_Id;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({})</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;SELECT Vessel_IMO, MMSI, Timestamp FROM AIS_MESSAGE WHERE MMSI = %s AND Vessel_IMO IS NOT NULL ORDER BY Timestamp DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">stat</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.read_vessel_information"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.read_vessel_information">[docs]</a>    <span class="k">def</span> <span class="nf">read_vessel_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">,</span> <span class="n">imo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 6, Priority 1</span>
<span class="sd">        From a vessel&#39;s MMSI and optional values IMO and Name, returns a vessel document matching the values given.</span>

<span class="sd">        :param mmsi: Vessel MMSI</span>
<span class="sd">        :type mmsi: int</span>
<span class="sd">        :param imo: Optional, Vessel IMO</span>
<span class="sd">        :type imo: int</span>
<span class="sd">        :param name: Optional, A dictionary of values to insert</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: A JSON vessel document formed with create_vessel_document()</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude, t.Vessel_IMO</span>
<span class="s2">                                      FROM (SELECT Id, MMSI, Vessel_IMO, Timestamp from AIS_MESSAGE WHERE MMSI = </span><span class="si">%s</span><span class="s2"> ORDER BY Timestamp DESC) t, POSITION_REPORT as pos</span>
<span class="s2">                                      WHERE t.Id = pos.AISMessage_Id;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">long</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
                        <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">long</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">imo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;SELECT Vessel_IMO, MMSI, Timestamp FROM AIS_MESSAGE WHERE MMSI = %s AND VESSEL_IMO = %s ORDER BY Timestamp DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">mmsi</span><span class="p">,</span> <span class="n">imo</span><span class="p">,))</span>
                        <span class="n">imodata</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">imodata</span> <span class="o">=</span> <span class="n">imodata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;SELECT Vessel_IMO, MMSI, Timestamp FROM AIS_MESSAGE WHERE MMSI = %s AND Vessel_IMO IS NOT NULL ORDER BY Timestamp DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                        <span class="n">imodata</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="sd">&quot;&quot;&quot;SELECT IMO FROM VESSEL WHERE MMSI = %s;&quot;&quot;&quot;</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                            <span class="n">imodata</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">imodata</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">imodata</span> <span class="o">=</span> <span class="n">imodata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">imodata</span> <span class="o">=</span> <span class="n">imodata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;SELECT Name FROM STATIC_DATA, AIS_MESSAGE WHERE Name = %s AND MMSI = %s AND AISMessage_Id = Id ORDER BY Timestamp DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">))</span>
                        <span class="n">namedata</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">namedata</span> <span class="o">=</span> <span class="n">namedata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;SELECT Name FROM STATIC_DATA, AIS_MESSAGE WHERE MMSI = %s AND AISMessage_Id = Id ORDER BY Timestamp DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                        <span class="n">namedata</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="sd">&quot;&quot;&quot;SELECT Name FROM VESSEL WHERE MMSI = %s;&quot;&quot;&quot;</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                            <span class="n">namedata</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">namedata</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">namedata</span> <span class="o">=</span> <span class="n">namedata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">namedata</span> <span class="o">=</span> <span class="n">namedata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">mmsi</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;IMO&quot;</span><span class="p">:</span> <span class="n">imodata</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">namedata</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.select_most_recent_5_ship_positions"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.select_most_recent_5_ship_positions">[docs]</a>    <span class="k">def</span> <span class="nf">select_most_recent_5_ship_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmsi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 10, Priority 3</span>
<span class="sd">        From a vessel MMSI, list the 5 most recent positions.</span>

<span class="sd">        :param mmsi: A vessel MMSI</span>
<span class="sd">        :type mmsi: int</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON string containing {&#39;MMSI&#39;: ..., &#39;Positions&#39;: [{&#39;lat&#39;: ..., &#39;long&#39;: ...}, ... ], &#39;IMO&#39;: ... }</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">mmsi</span><span class="p">,</span> <span class="s2">&quot;Positions&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;IMO&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude, t.Vessel_IMO</span>
<span class="s2">                                      FROM (SELECT Id, MMSI, Vessel_IMO, Timestamp FROM AIS_MESSAGE WHERE MMSI = </span><span class="si">%s</span><span class="s2"> ORDER BY Timestamp DESC LIMIT 5) t, POSITION_REPORT as pos</span>
<span class="s2">                                      WHERE t.Id = pos.AISMessage_Id;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">mmsi</span><span class="p">,</span> <span class="s2">&quot;Positions&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;IMO&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

                    <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                        <span class="n">temp_pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">])}</span>
                        <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_pos</span><span class="p">)</span>

                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;SELECT AISIMO FROM STATIC_DATA, AIS_MESSAGE WHERE AISMessage_Id = Id AND MMSI = %s ORDER BY Timestamp ASC;&quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">mmsi</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">imo</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">imo</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;MMSI&quot;</span><span class="p">:</span> <span class="n">mmsi</span><span class="p">,</span> <span class="s2">&quot;Positions&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">,</span> <span class="s1">&#39;IMO&#39;</span><span class="p">:</span> <span class="n">imo</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.recent_ships_positions_headed_to_given_portId"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.recent_ships_positions_headed_to_given_portId">[docs]</a>    <span class="k">def</span> <span class="nf">recent_ships_positions_headed_to_given_portId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 11, Priority 4</span>
<span class="sd">        From a port id, find all most recent ship positions of the vessels heading to that port</span>

<span class="sd">        :param port_id: The id of a port</span>
<span class="sd">        :type port_id: dict</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON string containing {&#39;vessels&#39;: [{&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}, ...]}</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude</span>
<span class="s2">                                      FROM (SELECT Id, MMSI, MAX(Timestamp) as LatestTime FROM AIS_MESSAGE WHERE Vessel_IMO IS NULL GROUP BY MMSI) t, POSITION_REPORT as pos, STATIC_DATA as sd</span>
<span class="s2">                                      WHERE t.Id = pos.AISMessage_Id AND pos.LastStaticData_Id = sd.AISMessage_Id AND sd.DestinationPort_Id = </span><span class="si">%s</span><span class="s2"> ORDER BY t.LatestTime DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">port_id</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_vessel_document</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">vessel</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
                            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="p">[]})</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="n">vessels</span><span class="p">})</span>

        <span class="c1"># return array of position documents</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.create_port_document"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.create_port_document">[docs]</a>    <span class="k">def</span> <span class="nf">create_port_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 2, Priority 2</span>
<span class="sd">        From a dictionary filled with message values, insert the values into the database and return a success message.</span>

<span class="sd">        :param port: A dictionary of port values to put into the document</span>
<span class="sd">        :type port: dict</span>
<span class="sd">        :return: A dictionary containing the port&#39;s Id, Name, Country, Latitude, Longitude, and all three tile ids</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;MapView1_Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;MapView2_Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;MapView3_Id&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;Country&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
            <span class="s2">&quot;MapView1_Id&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;MapView2_Id&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="s2">&quot;MapView3_Id&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="MySQL_DAO.recent_ships_positions_headed_to_given_port"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.recent_ships_positions_headed_to_given_port">[docs]</a>    <span class="k">def</span> <span class="nf">recent_ships_positions_headed_to_given_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 12, Priority 4</span>
<span class="sd">        From given port information, return either a list of matching ports or, if there is a single matching port,</span>
<span class="sd">        a list of vessel positions heading towards that port.</span>

<span class="sd">        :param port_name: The name of the port</span>
<span class="sd">        :type port_name: str</span>
<span class="sd">        :param country: The name of the country the port is in</span>
<span class="sd">        :type country: str</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: Either a JSON string containing {&#39;vessels&#39;: [{&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}, ...]}</span>
<span class="sd">            or a an array of objects containing the port&#39;s Id, Name, Country, Latitude, Longitude, and all three tile</span>
<span class="sd">            ids</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT PORT.Id FROM PORT WHERE PORT.Name = </span><span class="si">%s</span><span class="s2"> AND PORT.Country = </span><span class="si">%s</span><span class="s2">;&quot;&quot;&quot;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">))</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[]})</span>
                    <span class="k">elif</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_all_matching_ports</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude FROM (SELECT Id, MMSI, MAX(Timestamp) as </span>
<span class="sd">                            LatestTime from AIS_MESSAGE WHERE Vessel_IMO IS NULL GROUP BY MMSI) t, POSITION_REPORT as </span>
<span class="sd">                            pos, PORT as port, STATIC_DATA as sd WHERE t.Id = pos.AISMessage_Id AND pos.LastStaticData_Id </span>
<span class="sd">                            = sd.AISMessage_Id AND sd.DestinationPort_Id = port.Id AND port.Name = %s AND </span>
<span class="sd">                            port.Country = %s ORDER BY t.LatestTime DESC;&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">))</span>
                        <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_vessel_document</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                                <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="n">vessels</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessels&quot;</span><span class="p">:</span> <span class="p">[]})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.get_tile"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.get_tile">[docs]</a>    <span class="k">def</span> <span class="nf">get_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the boundaries of tile of scale 2 or 3 that contains the given position.</span>

<span class="sd">        :param scale: zoom level (2 or 3)</span>
<span class="sd">        :type scale: int</span>
<span class="sd">        :param long: longitude</span>
<span class="sd">        :type long: float</span>
<span class="sd">        :param lat: latitude</span>
<span class="sd">        :type lat: float</span>
<span class="sd">        :return: object {&#39;south&#39;: ... , &#39;north&#39;: ... , } describing the boundaries of the containing tile</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SOUTH</span><span class="p">,</span> <span class="n">NORTH</span><span class="p">,</span> <span class="n">WEST</span><span class="p">,</span> <span class="n">EAST</span> <span class="o">=</span> <span class="p">(</span><span class="mf">54.5</span><span class="p">,</span> <span class="mf">57.5</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">13.0</span><span class="p">)</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">SOUTH</span><span class="p">,</span> <span class="n">NORTH</span><span class="p">,</span> <span class="n">WEST</span><span class="p">,</span> <span class="n">EAST</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lat</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">lat</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">long</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">long</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lat</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">lat</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">long</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">long</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;south&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s1">&#39;east&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">}</span></div>

<div class="viewcode-block" id="MySQL_DAO.select_all_recent_in_tile"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.select_all_recent_in_tile">[docs]</a>    <span class="k">def</span> <span class="nf">select_all_recent_in_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 7, Priority 2</span>
<span class="sd">        From a tile id, find all most recent ship positions of the vessels in that tile</span>

<span class="sd">        :param tile_id: The id of a tile</span>
<span class="sd">        :type tile_id: int</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON string containing {&#39;vessels&#39;: [{&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}, ...]}</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessel&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT Scale</span>
<span class="s2">                                      FROM MAP_VIEW</span>
<span class="s2">                                      WHERE MAP_VIEW.Id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tile_id</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessel&quot;</span><span class="p">:</span> <span class="p">[]})</span>
                    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">statement</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT t.MMSI, pos.Latitude, pos.Longitude, t.Vessel_IMO</span>
<span class="s2">                                                    FROM (SELECT Id, MMSI, Vessel_IMO, max(Timestamp) max from AIS_MESSAGE WHERE Vessel_IMO IS NULL GROUP BY MMSI) t, POSITION_REPORT as pos</span>
<span class="s2">                                                    WHERE pos.MapView&quot;&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">rs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;_Id = </span><span class="si">%s</span><span class="s2"> AND t.Id = pos.AISMessage_Id;&quot;&quot;&quot;</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="p">(</span><span class="n">tile_id</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">vessel</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_vessel_document</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;vessel&quot;</span><span class="p">:</span> <span class="n">vessel</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.read_all_matching_ports"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.read_all_matching_ports">[docs]</a>    <span class="k">def</span> <span class="nf">read_all_matching_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 8, Priority 2</span>
<span class="sd">        Matches a port based on a port name or optional country, returning the port document</span>

<span class="sd">        :param port_name: The name of a port</span>
<span class="sd">        :type port_name: str</span>
<span class="sd">        :param country: Optional, the country a port is in</span>
<span class="sd">        :type country: str</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: JSON encoded port document containing the port&#39;s Id, Name, Country, Latitude, Longitude, and</span>
<span class="sd">            all three tile ids</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">country</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT Id, Name, Country, Longitude, Latitude, MapView1_Id, MapView2_Id, MapView3_Id</span>
<span class="s2">                                              FROM PORT</span>
<span class="s2">                                              WHERE PORT.Name = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">port_name</span><span class="p">,))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT Id, Name, Country, Longitude, Latitude, MapView1_Id, MapView2_Id, MapView3_Id</span>
<span class="s2">                                          FROM PORT</span>
<span class="s2">                                          WHERE PORT.Name = </span><span class="si">%s</span><span class="s2"> AND PORT.Country = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_port_document</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="n">ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ports&quot;</span><span class="p">:</span> <span class="n">ports</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.read_ship_pos_in_ts3_given_port"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.read_ship_pos_in_ts3_given_port">[docs]</a>    <span class="k">def</span> <span class="nf">read_ship_pos_in_ts3_given_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 9, Priority 2</span>
<span class="sd">        Based on a port&#39;s name and country, finds the ship positions in the scale 3 tile that the port is in.</span>
<span class="sd">        If no unique port is found, list all port documents with those parameters.</span>

<span class="sd">        :param port_name: The name of a port</span>
<span class="sd">        :type port_name: str</span>
<span class="sd">        :param country: Optional, the country a port is in</span>
<span class="sd">        :type country: str</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: Either a JSON string containing {&#39;vessels&#39;: [{&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}, ...]}</span>
<span class="sd">            or a an array of objects containing the port&#39;s Id, Name, Country, Latitude, Longitude, and all three tile</span>
<span class="sd">            ids</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;MapView1_Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;MapView2_Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;MapView3_Id&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT MAP_VIEW.id</span>
<span class="s2">                                      FROM MAP_VIEW, PORT</span>
<span class="s2">                                      WHERE PORT.MapView3_Id = MAP_VIEW.Id AND PORT.Name = </span><span class="si">%s</span><span class="s2"> AND PORT.Country = </span><span class="si">%s</span><span class="s2">;&quot;&quot;&quot;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">))</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[{</span>
                            <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;Country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;MapView1_Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;MapView2_Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;MapView3_Id&quot;</span><span class="p">:</span> <span class="kc">None</span>
                        <span class="p">}]})</span>
                    <span class="k">elif</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_all_matching_ports</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="n">country</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_all_recent_in_tile</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.create_tile_document"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.create_tile_document">[docs]</a>    <span class="k">def</span> <span class="nf">create_tile_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Based on a list of tile values, create a dictionary of said tile values with their keys</span>

<span class="sd">        :param tile: The list of tile values</span>
<span class="sd">        :type tile: list</span>
<span class="sd">        :return: A dictionary containing all keys for a tile and the values of the specific tile passed in</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LongitudeW&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LatitudeS&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LongitudeE&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;LatitudeN&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Scale&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;RasterFile&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ImageWidth&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ImageHeight&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ActualLongitudeW&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ActualLatitudeS&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ActualLongitudeE&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ActualLatitudeN&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;ContainerMapView_Id&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;LongitudeW&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="s2">&quot;LatitudeS&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="s2">&quot;LongitudeE&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
            <span class="s2">&quot;LatitudeN&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
            <span class="s2">&quot;Scale&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="s2">&quot;RasterFile&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
            <span class="s2">&quot;ImageWidth&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
            <span class="s2">&quot;ImageHeight&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
            <span class="s2">&quot;ActualLongitudeW&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span>
            <span class="s2">&quot;ActualLatitudeS&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">11</span><span class="p">]),</span>
            <span class="s2">&quot;ActualLongitudeE&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">12</span><span class="p">]),</span>
            <span class="s2">&quot;ActualLatitudeN&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">13</span><span class="p">]),</span>
            <span class="s2">&quot;ContainerMapView_Id&quot;</span><span class="p">:</span> <span class="n">tile</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="MySQL_DAO.given_tile_find_contained_tiles"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.given_tile_find_contained_tiles">[docs]</a>    <span class="k">def</span> <span class="nf">given_tile_find_contained_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_tile_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 13, Priority 4</span>
<span class="sd">        Return the four map tile documents of the tiles contained within the tile whose Id is passed in</span>

<span class="sd">        :param map_tile_id: The Id of a map tile</span>
<span class="sd">        :type map_tile_id: str</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: Either a JSON string containing {&#39;vessels&#39;: [{&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}, ...]}</span>
<span class="sd">            or a an array of objects containing the port&#39;s Id, Name, Country, Latitude, Longitude, and all three tile</span>
<span class="sd">            ids</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;tiles&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT map3.*</span>
<span class="s2">                                      FROM MAP_VIEW as map3, MAP_VIEW as map2</span>
<span class="s2">                                      WHERE map2.Id= </span><span class="si">%s</span><span class="s2"> AND map3.ContainerMapView_Id=map2.Id;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">map_tile_id</span><span class="p">,))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">tiles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tile_document</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="n">tiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;tiles&quot;</span><span class="p">:</span> <span class="n">tiles</span><span class="p">})</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="MySQL_DAO.given_tile_id_get_tile"><a class="viewcode-back" href="../MySQL_DAO.html#MySQL_DAO.MySQL_DAO.given_tile_id_get_tile">[docs]</a>    <span class="k">def</span> <span class="nf">given_tile_id_get_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_tile_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query 14, Priority 4</span>
<span class="sd">        Return the actual tile (a PNG file), the binary data.</span>

<span class="sd">        :param map_tile_id: The Id of a map tile</span>
<span class="sd">        :type map_tile_id: str</span>
<span class="sd">        :raises [BaseException]: If the connection fails</span>
<span class="sd">        :return: Either a JSON string containing {&#39;vessels&#39;: [{&#39;MMSI&#39;: ..., &#39;lat&#39;: ..., &#39;long&#39;: ..., &#39;IMO&#39;: ...}, ...]}</span>
<span class="sd">            or a an array of objects containing the port&#39;s Id, Name, Country, Latitude, Longitude, and all three tile</span>
<span class="sd">            ids</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stub</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">map_tile_id</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">MySQLConnectionManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">MySQLCursorManager</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT MAP_VIEW.RasterFile</span>
<span class="s2">                                       FROM MAP_VIEW</span>
<span class="s2">                                       WHERE MAP_VIEW.Id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">map_tile_id</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">tile_image</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;denmark_tiles&#39;</span><span class="p">,</span> <span class="n">tile_image</span><span class="p">))</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">file_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="k">return</span> <span class="n">file_data</span>

        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong with your user name or password&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">CS418_Milestone_4</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">CS418_Milestone4</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Group 5.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>